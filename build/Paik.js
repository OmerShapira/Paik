Pk.Clip=function(a,c,e,k){this.interval=new Pk.Interval(a,c);this.interval.clip=this;this.resources=e;this.playFunction=k};Pk.Clip.prototype={Load:function(){resources.forEach(function(a){a.Load()})},Dispose:function(){resources.forEach(function(a){a.Dispose()})},Play:function(a){resources.forEach(function(a){a.Begin()});a.Register(this.playFunction)},Stop:function(a){resources.forEach(function(a){a.End()});a.Unregister(this.playFunction)}};Pk.Player=function(){function a(m){e=window.requestAnimationFrame(a);c(m)}function c(a){l.forEach(function(c){c(a)})}var e,k=!1,l=[];return{Start:function(){!0!==k&&(e=window.requestAnimationFrame(a),k=!0)},Stop:function(){window.cancelAnimationFrame(e);k=!1},Subscribe:function(a){l.push(a)},ConnectMixin:function(a){Pk.Util.Exists(a)&&(Pk.ActiveMixin=new Pk.Mixin(a))}}}();Pk.Interval=function(a,c){this.id=++Pk.Interval.prototype.id;this.from=a;this.to=c;this.overlap={}};Pk.Interval.prototype.id=0;Pk.Interval["const"]=Pk.Interval.prototype;Pk.Interval.prototype.SUBSET=1;Pk.Interval.prototype.DISJOINT=2;Pk.Interval.prototype.INTERSECT_OR_SUPERSET=3;Pk.Interval.prototype.clip=null;Pk.Interval.prototype.compareTo=function(a){return a.from>this.to||a.to<this.from?this.DISJOINT:a.from<=this.from&&a.to>=this.to?this.SUBSET:this.INTERSECT_OR_SUPERSET};
Pk.Interval.prototype.disjointIncl=function(a){if(a.from>this.to||a.to<this.from)return this.DISJOINT};Pk.Interval.prototype.disjointExcl=function(a){if(a.from>=this.to||a.to<=this.from)return this.DISJOINT};
Pk.IntervalTree=function(){var a=null,c=[],e=function(d,g){this.right=this.left=null;this.segment=new Pk.Interval(d,g);this.intervals=[]},k=function(){var d=[];d.push(-Infinity);d.push(Infinity);c.forEach(function(g){d.push(g.from);d.push(g.to)});return l(d,function(d,b){return d-b})},l=function(d,g){var b=[],a;d.sort(g).forEach(function(d){if(void 0!==g&&void 0!==a?0!==g(a,d):a!==d)b.push(d),a=d});return b},m=function(d){var a;if(2===d.length)a=new e(d[0],d[1]),Infinity!==d[1]&&(a.left=new e(d[0],
d[1]),a.right=new e(d[1],d[1]));else{a=new e(d[0],d[d.length-1]);var b=Math.floor(d.length/2);a.left=m(d.slice(0,b+1));a.right=m(d.slice(b))}return a},n=function(d,a){switch(d.segment.compareTo(a)){case Pk.Interval["const"].SUBSET:d.intervals.push(a);break;case Pk.Interval["const"].INTERSECT_OR_SUPERSET:d.left&&n(d.left,a),d.right&&n(d.right,a)}},p=function(d,a,b){null!==d&&(void 0!==a&&a(d),p(d.right,a,b),p(d.left,a,b),void 0!==b&&b(d))},h=function(d,a,b){if(null!==d)return void 0===a&&(a=-1),void 0===
b&&(b=[]),a++,b[a]||(b[a]=[]),b[a].push(d),h(d.right,a,b),h(d.left,a,b),b},q=function(d,a,b,c){null!==d&&a.forEach(function(h){c.call(d.segment,h)!==Pk.Interval["const"].DISJOINT&&(d.intervals.forEach(function(a){b[a.id]=a}),q(d.right,a,b,c),q(d.left,a,b,c))})},f=function(d,g,b){var c={};void 0===b&&(b=Pk.Interval.prototype.disjointIncl);q(a,d,c,b);d=Object.keys(c).map(function(a){return c[a]});void 0!==g&&"function"===typeof g&&g(c);return d.length},r=function(a,g){if(null!==a){var b;if(0!==a.intervals.length){b=
a.intervals;for(var c=0;c<g.length;c++)for(var h=g[c],f=0;f<b.length;f++)b[f].overlap[h.id]=h,h.overlap[b[f].id]=b[f];for(c=0;c<b.length;c++)for(f=c+1;f<b.length;f++)b[c].overlap[b[f].id]=b[f],b[f].overlap[b[c].id]=b[c];b=g.concat(a.intervals)}else b=g;r(a.left,b);r(a.right,b)}},t=function(a,c){if("number"!==typeof a||"number"!==typeof c)throw{name:"InvalidInterval",message:"endpoints of interval must be of type number"};if(a>c)throw{name:"InvalidInterval",message:"("+a+","+c+") a > b"};},u=function(a,
c){if(!(a instanceof Array&&c instanceof Array))throw{name:"InvalidParameter",message:"function pushArray: parameters must be arrays"};if(a.length!==c.length)throw{name:"InvalidParameter",message:"function pushArray: arrays must have same length"};for(var b=0;b<a.length;b++)t(a[b],c[b])},v=function(a){if(!(a instanceof Array))throw{name:"InvalidParameter",message:"parameter must be an array"};for(var c=0;c<a.length;c++)if("number"!==typeof a[c])throw{name:"InvalidParameter",message:"array must consist only of numbers"};
};return{pushInterval:function(a){t(a.from,a.to);c.push(a)},pushArray:function(a,g,b){(void 0!==b?b:1)&&u(a,g);for(b=0;b<a.length;b++)c.push(new Pk.Interval(a[b],g[b]))},clearIntervalStack:function(){c.length=0;Pk.Interval.prototype.id=0},buildTree:function(){if(0===c.length)throw{name:"BuildTreeError",message:"interval stack is empty"};a=m(k());c.forEach(function(d){n(a,d)})},printTree:function(){p(a,function(a){console.log("\nSegment: (%d,%d)",a.segment.from,a.segment.to);a.intervals.forEach(function(a,
b){console.log("Interval %d: (%d,%d)",b,a.from,a.to)})})},printTreeTopDown:function(){h(a).forEach(function(a,c){console.log("Level %d:",c);a.forEach(function(a,d){console.log("Segment %d: (%d,%d)",d,a.segment.from,a.segment.to);a.intervals.forEach(function(a,b){console.log("  Pk.Interval %d: (%d,%d)",b,a.from,a.to)})})})},queryPoint:function(a,c){if("number"!==typeof a)throw{name:"InvalidParameter",message:"parameter must be a number"};return this.queryPointArray([a],c)},queryPointArray:function(a,
c,b){(void 0!==b?b:1)&&v(a);a=a.map(function(a){return new Pk.Interval(a,a)});return f(a,c)},queryInterval:function(a,c,b){t(a,c);return this.queryIntervalArray([a],[c],b)},queryIntervalArray:function(a,c,b){var h=[],e=void 0!==b&&void 0!==b.resultFn?b.resultFn:void 0,q=void 0!==b&&!1===b.endpoints?Pk.Interval.prototype.disjointExcl:Pk.Interval.prototype.disjointIncl;(void 0!==b&&void 0!==b.validate?b.validate:1)&&u(a,c);for(b=0;b<a.length;b++)h.push(new Pk.Interval(a[b],c[b]));return f(h,e,q)},queryOverlap:function(){r(a,
[]);var d=[];c.forEach(function(a){var b=new Pk.Interval;b.id=a.id;b.from=a.from;b.to=a.to;b.overlap=Object.keys(a.overlap);d.push(b)});return d}}};Pk.Mixin=function(a){this.type="Pk.Mixin";Pk.Util.Exists(a)?"Add Remove Begin Tick Draw End".split(" ").forEach(function(c){Pk.Util.IsFunction(a[c])?this[c]=a[c]:console.warn(c+" is not implemented in this mixin")}.bind(this)):console.error("Not a valid Mixin")};Pk.Mixin.prototype.Add=function(a){};Pk.Mixin.prototype.Remove=function(a){};Pk.Mixin.prototype.Begin=function(a){};Pk.Mixin.prototype.Tick=function(a){};Pk.Mixin.prototype.Draw=function(){};Pk.Mixin.prototype.End=function(a){};Pk={};Pk.Resource=function(){};Pk.Resource.prototype.Load=function(){console.error("NOT IMPLEMENTED")};Pk.Resource.prototype.Dispose=function(){console.error("NOT IMPLEMENTED")};Pk.TimecodeController=function(a){timePoll=a;Pk.Player.Subscribe(this.Tick.bind(this))};Pk.TimecodeController.prototype={subscribers:[],currentTimecode:0,Subscribe:function(a){this.subscribers.push(a)},SendTimecodeTick:function(a){this.subscribers.forEach(function(c){c(a)})},Tick:function(){var a=timePoll();a!=this.currentTimecode&&(this.currentTimecode=a,this.SendTimecodeTick(a))}};Pk.Timeline=function(){var a=0,c=null,e=[],k=!1,l={},m=function(a){var c=[];Object.keys(l).forEach(function(f){if(Pk.Util.Exists(a[f]))delete a[f];else{var e=l[f];delete l[f];c.push(e.clip)}});p(c);n(Object.keys(a).map(function(c){return a[c].clip}));Object.keys(a).forEach(function(c){l[c]=a[c]})},n=function(a){a.forEach(function(a){console.log("adding: "+a.interval.id);a.resources.forEach(function(a){Pk.ActiveMixin.Add(a)})})},p=function(a){a.forEach(function(a){console.log("removing: "+a.interval.id);
a.resources.forEach(function(a){Pk.ActiveMixin.Remove(a)})})};return{BindTimecodeController:function(a){a.Subscribe(this.SetTimecode.bind(this))},SetTimecode:function(h,e){Pk.Util.Exists(e)||(e=!0);if(e){var f={resultFn:m.bind(this)};c.queryInterval(a,h,f)}Pk.ActiveMixin.Tick(h);Pk.ActiveMixin.Draw();a=h},Build:function(){c=new Pk.IntervalTree;e.forEach(function(a){c.pushInterval(a.interval)});c.buildTree();k=!0},Add:function(){if(!0===k)console.warn("Trying to add clips to a built timeline");else for(var a=
arguments.length-1;0<=a;a--)e.push(arguments[a])},SetPlayMode:function(a){Pk.Util.IsBool(a)}}}();Pk.Util={};Pk.Util.Work=function(a){for(var c=0;c<a;c++);};Pk.Util.Exists=function(a){return"undefined"!==typeof a};Pk.Util.IsBool=function(a){return!0===a||!1===a};Pk.Util.IsFunction=function(a){var c={};return Pk.Util.Exists(a)&&"[object Function]"===c.toString.call(a)};Pk.Video=function(a){time=-.01;videoElement=a;this.Initialize()};Pk.Video.FromUrl=function(a){var c=document.createElement("video"),e=document.createElement("source");e.src=a;c.appendChild(e);return new Pk.Video(c)};
Pk.Video.prototype={Time:function(){return Math.trunc(1E3*videoElement.currentTime)},Initialize:function(){videoImage=document.createElement("canvas");videoImage.width=videoElement.videoWidth;videoImage.height=videoElement.videoHeight;console.log("Video Size :"+videoImage.width+" "+videoImage.height);videoContext=videoImage.getContext("2d");videoContext.fillStyle="#000000";videoContext.fillRect(0,0,videoImage.width,videoImage.height);this.context=videoContext},StartPlaying:function(){videoElement.play();
videoElement.muted=!0;videoElement.loop=!0},GetMaterial:function(){this.texture||(videoTexture=new THREE.Texture(videoImage),videoTexture.minFilter=THREE.LinearFilter,videoTexture.magFilter=THREE.LinearFilter,this.texture=videoTexture);return movieMaterial=new THREE.MeshBasicMaterial({map:videoTexture,overdraw:!0,side:THREE.DoubleSide})},Tick:function(){videoElement.readyState===videoElement.HAVE_ENOUGH_DATA&&(this.context.drawImage(videoElement,0,0),this.texture&&(this.texture.needsUpdate=!0))},
Interrupted:function(){},GetTimecodeController:function(){return new Pk.TimecodeController(this.Time)}};