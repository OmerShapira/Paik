Pk.Clip=function(a,b,e,h){this.interval=new Pk.Interval(a,b);this.interval.clip=this;this.resources=e;Pk.Util.IsFunction(h)&&(this.tickFunction=h.bind(this))};Pk.Clip.prototype={Tick:function(a){tickFunction(a)},Load:function(){resources.forEach(function(a){a.Load()})},Dispose:function(){resources.forEach(function(a){a.Dispose()})},Play:function(){resources.forEach(function(a){a.Begin()})},Stop:function(){resources.forEach(function(a){a.End()})}};Pk.Player=function(){function a(e){b=window.requestAnimationFrame(a);Pk.TimecodeTrack.Update(e)}var b,e=!1;return{Start:function(){!0!==e&&(b=window.requestAnimationFrame(a),e=!0)},Stop:function(){window.cancelAnimationFrame(b);e=!1},SetTimecodeTrack:function(a){if(a instanceof Pk.TimecodeController)Pk.TimecodeTrack=a;else throw"Trying to set an invalid timecode controller";},Build:function(){Pk.Timeline.Build()}}}();Pk.Groups=[];Pk.Group=function(a,b){this.name=a;b instanceof Pk.GroupController?this.controller=b:console.warn("Group "+a+": controller argument isn't of type Pk.GropuController");this.subscribers=new Set};
Pk.Group.prototype={Add:function(a){if(a instanceof Pk.Clip)a.group=this,Pk.Timeline.Add(a);else throw"Not a valid clip";},ActivateClip:function(a){Pk.Util.IsFunction(a.tickFunction)&&this.subscribers.add(a.tickFunction);a.resources.forEach(function(a){this.controller.Add(a)}.bind(this))},DeactivateClip:function(a){Pk.Util.IsFunction(a.tickFunction)&&this.subscribers["delete"](a.tickFunction);a.resources.forEach(function(a){this.controller.Remove(a)}.bind(this))},Tick:function(a){this.controller.Tick(a);
this.subscribers.forEach(function(b){b(a)})},Draw:function(){this.controller.Draw()}};Pk.GroupController=function(a){Pk.Util.Exists(a)?"Add Remove Begin Tick Draw End".split(" ").forEach(function(b){Pk.Util.IsFunction(a[b])?this[b]=a[b]:console.warn(b+" is not implemented in this GroupController")}.bind(this)):console.error("Not a valid GroupController")};Pk.GroupController.prototype.Add=function(a){};Pk.GroupController.prototype.Remove=function(a){};Pk.GroupController.prototype.Begin=function(a){};Pk.GroupController.prototype.Tick=function(a){};Pk.GroupController.prototype.Draw=function(){};
Pk.GroupController.prototype.End=function(a){};Pk.Interval=function(a,b){this.id=++Pk.Interval.prototype.id;this.from=a;this.to=b;this.overlap={}};Pk.Interval.prototype.id=0;Pk.Interval.cnst=Pk.Interval.prototype;Pk.Interval.prototype.SUBSET=1;Pk.Interval.prototype.DISJOINT=2;Pk.Interval.prototype.INTERSECT_OR_SUPERSET=3;Pk.Interval.prototype.clip=null;Pk.Interval.prototype.compareTo=function(a){return a.from>this.to||a.to<this.from?this.DISJOINT:a.from<=this.from&&a.to>=this.to?this.SUBSET:this.INTERSECT_OR_SUPERSET};
Pk.Interval.prototype.disjointIncl=function(a){if(a.from>this.to||a.to<this.from)return this.DISJOINT};Pk.Interval.prototype.disjointExcl=function(a){if(a.from>=this.to||a.to<=this.from)return this.DISJOINT};
Pk.IntervalTree=function(){var a=null,b=[],e=function(d,a){this.right=this.left=null;this.segment=new Pk.Interval(d,a);this.intervals=[]},h=function(){var d=[];d.push(-Infinity);d.push(Infinity);b.forEach(function(a){d.push(a.from);d.push(a.to)});return l(d,function(d,a){return d-a})},l=function(d,a){var c=[],b;d.sort(a).forEach(function(d){if(void 0!==a&&void 0!==b?0!==a(b,d):b!==d)c.push(d),b=d});return c},m=function(d){var a;if(2===d.length)a=new e(d[0],d[1]),Infinity!==d[1]&&(a.left=new e(d[0],
d[1]),a.right=new e(d[1],d[1]));else{a=new e(d[0],d[d.length-1]);var c=Math.floor(d.length/2);a.left=m(d.slice(0,c+1));a.right=m(d.slice(c))}return a},n=function(d,a){switch(d.segment.compareTo(a)){case Pk.Interval.cnst.SUBSET:d.intervals.push(a);break;case Pk.Interval.cnst.INTERSECT_OR_SUPERSET:d.left&&n(d.left,a),d.right&&n(d.right,a)}},p=function(a,f,c){null!==a&&(void 0!==f&&f(a),p(a.right,f,c),p(a.left,f,c),void 0!==c&&c(a))},g=function(a,f,c){if(null!==a)return void 0===f&&(f=-1),void 0===c&&
(c=[]),f++,c[f]||(c[f]=[]),c[f].push(a),g(a.right,f,c),g(a.left,f,c),c},k=function(a,f,c,b){null!==a&&f.forEach(function(g){b.call(a.segment,g)!==Pk.Interval.cnst.DISJOINT&&(a.intervals.forEach(function(a){c[a.id]=a}),k(a.right,f,c,b),k(a.left,f,c,b))})},t=function(d,f,c){var b={};void 0===c&&(c=Pk.Interval.prototype.disjointIncl);k(a,d,b,c);d=Object.keys(b).map(function(a){return b[a]});void 0!==f&&"function"===typeof f&&f(b);return d.length},q=function(a,f){if(null!==a){var c;if(0!==a.intervals.length){c=
a.intervals;for(var b=0;b<f.length;b++)for(var g=f[b],e=0;e<c.length;e++)c[e].overlap[g.id]=g,g.overlap[c[e].id]=c[e];for(b=0;b<c.length;b++)for(e=b+1;e<c.length;e++)c[b].overlap[c[e].id]=c[e],c[e].overlap[c[b].id]=c[b];c=f.concat(a.intervals)}else c=f;q(a.left,c);q(a.right,c)}},r=function(a,b){if("number"!==typeof a||"number"!==typeof b)throw{name:"InvalidInterval",message:"endpoints of interval must be of type number"};if(a>b)throw{name:"InvalidInterval",message:"("+a+","+b+") a > b"};},u=function(a,
b){if(!(a instanceof Array&&b instanceof Array))throw{name:"InvalidParameter",message:"function pushArray: parameters must be arrays"};if(a.length!==b.length)throw{name:"InvalidParameter",message:"function pushArray: arrays must have same length"};for(var c=0;c<a.length;c++)r(a[c],b[c])},v=function(a){if(!(a instanceof Array))throw{name:"InvalidParameter",message:"parameter must be an array"};for(var b=0;b<a.length;b++)if("number"!==typeof a[b])throw{name:"InvalidParameter",message:"array must consist only of numbers"};
};return{pushInterval:function(a){r(a.from,a.to);b.push(a)},pushArray:function(a,f,c){(void 0!==c?c:1)&&u(a,f);for(c=0;c<a.length;c++)b.push(new Pk.Interval(a[c],f[c]))},clearIntervalStack:function(){b.length=0;Pk.Interval.prototype.id=0},buildTree:function(){if(0===b.length)throw{name:"BuildTreeError",message:"interval stack is empty"};a=m(h());b.forEach(function(b){n(a,b)})},printTree:function(){p(a,function(a){console.log("\nSegment: (%d,%d)",a.segment.from,a.segment.to);a.intervals.forEach(function(a,
c){console.log("Interval %d: (%d,%d)",c,a.from,a.to)})})},printTreeTopDown:function(){g(a).forEach(function(a,b){console.log("Level %d:",b);a.forEach(function(a,b){console.log("Segment %d: (%d,%d)",b,a.segment.from,a.segment.to);a.intervals.forEach(function(a,c){console.log("  Pk.Interval %d: (%d,%d)",c,a.from,a.to)})})})},queryPoint:function(a,b){if("number"!==typeof a)throw{name:"InvalidParameter",message:"parameter must be a number"};return this.queryPointArray([a],b)},queryPointArray:function(a,
b,c){(void 0!==c?c:1)&&v(a);a=a.map(function(a){return new Pk.Interval(a,a)});return t(a,b)},queryInterval:function(a,b,c){r(a,b);return this.queryIntervalArray([a],[b],c)},queryIntervalArray:function(a,b,c){var g=[],e=void 0!==c&&void 0!==c.resultFn?c.resultFn:void 0,k=void 0!==c&&!1===c.endpoints?Pk.Interval.prototype.disjointExcl:Pk.Interval.prototype.disjointIncl;(void 0!==c&&void 0!==c.validate?c.validate:1)&&u(a,b);for(c=0;c<a.length;c++)g.push(new Pk.Interval(a[c],b[c]));return t(g,e,k)},queryOverlap:function(){q(a,
[]);var d=[];b.forEach(function(a){var b=new Pk.Interval;b.id=a.id;b.from=a.from;b.to=a.to;b.overlap=Object.keys(a.overlap);d.push(b)});return d}}};Pk={};Pk.Resource=function(){};Pk.Resource.prototype.Load=function(){console.error("NOT IMPLEMENTED")};Pk.Resource.prototype.Dispose=function(){console.error("NOT IMPLEMENTED")};Pk.TimecodeController=function(a){timePoll=a};Pk.TimecodeController.prototype={currentTimecode:0,SendTimecodeTick:function(a){Pk.Timeline.SetTimecode(a)},Update:function(){var a=timePoll();a!=this.currentTimecode&&(this.currentTimecode=a,this.SendTimecodeTick(a))}};Pk.Timeline=function(){var a=0,b=null,e=[],h=!1,l={},m=function(a){var b=[];Object.keys(l).forEach(function(e){if(Pk.Util.Exists(a[e]))delete a[e];else{var q=l[e];delete l[e];b.push(q.clip)}});p(b);n(Object.keys(a).map(function(b){return a[b].clip}));Object.keys(a).forEach(function(b){l[b]=a[b]})},n=function(a){a.forEach(function(a){a.group.ActivateClip(a)})},p=function(a){a.forEach(function(a){a.group.DeactivateClip(a)})};return{SetTimecode:function(e,k){Pk.Util.Exists(k)||(k=!0);if(k){var h={resultFn:m.bind(this)};
b.queryInterval(a,e,h)}Pk.Groups.forEach(function(a){a.Tick(e)});Pk.Groups.forEach(function(a){a.Draw()});a=e},Build:function(){b=new Pk.IntervalTree;e.forEach(function(a){b.pushInterval(a.interval)});b.buildTree();h=!0},Add:function(){if(!0===h)console.warn("Trying to add clips to a built timeline");else for(var a=arguments.length-1;0<=a;a--)if(arguments[a]instanceof Pk.Clip)e.push(arguments[a]);else throw"Trying to add a non-clip to the timeline";},SetPlayMode:function(a){Pk.Util.IsBool(a)}}}();Pk.Util={};Pk.Util.Work=function(a){for(var b=0;b<a;b++);};Pk.Util.Exists=function(a){return"undefined"!==typeof a};Pk.Util.IsBool=function(a){return!0===a||!1===a};Pk.Util.IsFunction=function(a){var b={};return Pk.Util.Exists(a)&&"[object Function]"===b.toString.call(a)};Pk.Video=function(a){time=-.01;videoElement=a;this.Initialize()};Pk.Video.FromUrl=function(a){var b=document.createElement("video"),e=document.createElement("source");e.src=a;b.appendChild(e);return new Pk.Video(b)};
Pk.Video.prototype={Time:function(){return Math.trunc(1E3*videoElement.currentTime)},Initialize:function(){videoImage=document.createElement("canvas");videoImage.width=videoElement.videoWidth;videoImage.height=videoElement.videoHeight;console.log("Video Size :"+videoImage.width+" "+videoImage.height);videoContext=videoImage.getContext("2d");videoContext.fillStyle="#000000";videoContext.fillRect(0,0,videoImage.width,videoImage.height);this.context=videoContext},StartPlaying:function(){videoElement.play();
videoElement.muted=!0;videoElement.loop=!0},GetMaterial:function(){this.texture||(videoTexture=new THREE.Texture(videoImage),videoTexture.minFilter=THREE.LinearFilter,videoTexture.magFilter=THREE.LinearFilter,this.texture=videoTexture);return movieMaterial=new THREE.MeshBasicMaterial({map:videoTexture,overdraw:!0,side:THREE.DoubleSide})},Tick:function(){videoElement.readyState===videoElement.HAVE_ENOUGH_DATA&&(this.context.drawImage(videoElement,0,0),this.texture&&(this.texture.needsUpdate=!0))},
Interrupted:function(){},GetTimecodeController:function(){return new Pk.TimecodeController(this.Time)}};