Pk.Clip=function(a,c,e,k){this.interval=new Pk.Interval(a,c);this.interval.clip=this;this.resources=e;this.tickFunction=k.bind(this)};Pk.Clip.prototype={Tick:function(a){tickFunction(a)},Load:function(){resources.forEach(function(a){a.Load()})},Dispose:function(){resources.forEach(function(a){a.Dispose()})},Play:function(){resources.forEach(function(a){a.Begin()})},Stop:function(){resources.forEach(function(a){a.End()})}};Pk.Player=function(){function a(e){c=window.requestAnimationFrame(a);Pk.TimecodeTrack.Update(e)}var c,e=!1;return{Start:function(){!0!==e&&(c=window.requestAnimationFrame(a),e=!0)},Stop:function(){window.cancelAnimationFrame(c);e=!1},ConnectMixin:function(a){Pk.Util.Exists(a)&&(Pk.ActiveMixin=new Pk.Mixin(a))},SetTimecodeTrack:function(a){Pk.TimecodeTrack=a}}}();Pk.Groups=[];Pk.Group=function(a,c){this.name=a;this.controller=c;this.subscribers=new Set;this.self=this};
Pk.Group.prototype={Add:function(a){if(a instanceof Pk.Clip)a.group=this,Pk.Timeline.Add(a);else throw"Not a valid clip";},ActivateClip:function(a){this.subscribers.add(a.tickFunction);a.resources.forEach(function(a){this.controller.Add(a)}.bind(this))},DeactivateClip:function(a){this.subscribers["delete"](a.tickFunction);a.resources.forEach(function(a){this.controller.Remove(a)}.bind(this))},Tick:function(a){this.controller.Tick(a);this.subscribers.forEach(function(c){c(a)})},Draw:function(){this.controller.Draw()}};Pk.GroupController=function(a){this.type="Pk.GroupController";Pk.Util.Exists(a)?"Add Remove Begin Tick Draw End".split(" ").forEach(function(c){Pk.Util.IsFunction(a[c])?this[c]=a[c]:console.warn(c+" is not implemented in this GroupController")}.bind(this)):console.error("Not a valid GroupController")};Pk.GroupController.prototype.Add=function(a){};Pk.GroupController.prototype.Remove=function(a){};Pk.GroupController.prototype.Begin=function(a){};Pk.GroupController.prototype.Tick=function(a){};
Pk.GroupController.prototype.Draw=function(){};Pk.GroupController.prototype.End=function(a){};Pk.Interval=function(a,c){this.id=++Pk.Interval.prototype.id;this.from=a;this.to=c;this.overlap={}};Pk.Interval.prototype.id=0;Pk.Interval["const"]=Pk.Interval.prototype;Pk.Interval.prototype.SUBSET=1;Pk.Interval.prototype.DISJOINT=2;Pk.Interval.prototype.INTERSECT_OR_SUPERSET=3;Pk.Interval.prototype.clip=null;Pk.Interval.prototype.compareTo=function(a){return a.from>this.to||a.to<this.from?this.DISJOINT:a.from<=this.from&&a.to>=this.to?this.SUBSET:this.INTERSECT_OR_SUPERSET};
Pk.Interval.prototype.disjointIncl=function(a){if(a.from>this.to||a.to<this.from)return this.DISJOINT};Pk.Interval.prototype.disjointExcl=function(a){if(a.from>=this.to||a.to<=this.from)return this.DISJOINT};
Pk.IntervalTree=function(){var a=null,c=[],e=function(f,a){this.right=this.left=null;this.segment=new Pk.Interval(f,a);this.intervals=[]},k=function(){var f=[];f.push(-Infinity);f.push(Infinity);c.forEach(function(a){f.push(a.from);f.push(a.to)});return l(f,function(f,a){return f-a})},l=function(f,a){var b=[],c;f.sort(a).forEach(function(f){if(void 0!==a&&void 0!==c?0!==a(c,f):c!==f)b.push(f),c=f});return b},m=function(f){var a;if(2===f.length)a=new e(f[0],f[1]),Infinity!==f[1]&&(a.left=new e(f[0],
f[1]),a.right=new e(f[1],f[1]));else{a=new e(f[0],f[f.length-1]);var b=Math.floor(f.length/2);a.left=m(f.slice(0,b+1));a.right=m(f.slice(b))}return a},n=function(a,d){switch(a.segment.compareTo(d)){case Pk.Interval["const"].SUBSET:a.intervals.push(d);break;case Pk.Interval["const"].INTERSECT_OR_SUPERSET:a.left&&n(a.left,d),a.right&&n(a.right,d)}},p=function(a,d,b){null!==a&&(void 0!==d&&d(a),p(a.right,d,b),p(a.left,d,b),void 0!==b&&b(a))},g=function(a,d,b){if(null!==a)return void 0===d&&(d=-1),void 0===
b&&(b=[]),d++,b[d]||(b[d]=[]),b[d].push(a),g(a.right,d,b),g(a.left,d,b),b},h=function(a,d,b,c){null!==a&&d.forEach(function(g){c.call(a.segment,g)!==Pk.Interval["const"].DISJOINT&&(a.intervals.forEach(function(a){b[a.id]=a}),h(a.right,d,b,c),h(a.left,d,b,c))})},t=function(f,d,b){var c={};void 0===b&&(b=Pk.Interval.prototype.disjointIncl);h(a,f,c,b);f=Object.keys(c).map(function(a){return c[a]});void 0!==d&&"function"===typeof d&&d(c);return f.length},q=function(a,d){if(null!==a){var b;if(0!==a.intervals.length){b=
a.intervals;for(var c=0;c<d.length;c++)for(var g=d[c],e=0;e<b.length;e++)b[e].overlap[g.id]=g,g.overlap[b[e].id]=b[e];for(c=0;c<b.length;c++)for(e=c+1;e<b.length;e++)b[c].overlap[b[e].id]=b[e],b[e].overlap[b[c].id]=b[c];b=d.concat(a.intervals)}else b=d;q(a.left,b);q(a.right,b)}},r=function(a,d){if("number"!==typeof a||"number"!==typeof d)throw{name:"InvalidInterval",message:"endpoints of interval must be of type number"};if(a>d)throw{name:"InvalidInterval",message:"("+a+","+d+") a > b"};},u=function(a,
d){if(!(a instanceof Array&&d instanceof Array))throw{name:"InvalidParameter",message:"function pushArray: parameters must be arrays"};if(a.length!==d.length)throw{name:"InvalidParameter",message:"function pushArray: arrays must have same length"};for(var b=0;b<a.length;b++)r(a[b],d[b])},v=function(a){if(!(a instanceof Array))throw{name:"InvalidParameter",message:"parameter must be an array"};for(var d=0;d<a.length;d++)if("number"!==typeof a[d])throw{name:"InvalidParameter",message:"array must consist only of numbers"};
};return{pushInterval:function(a){r(a.from,a.to);c.push(a)},pushArray:function(a,d,b){(void 0!==b?b:1)&&u(a,d);for(b=0;b<a.length;b++)c.push(new Pk.Interval(a[b],d[b]))},clearIntervalStack:function(){c.length=0;Pk.Interval.prototype.id=0},buildTree:function(){if(0===c.length)throw{name:"BuildTreeError",message:"interval stack is empty"};a=m(k());c.forEach(function(c){n(a,c)})},printTree:function(){p(a,function(a){console.log("\nSegment: (%d,%d)",a.segment.from,a.segment.to);a.intervals.forEach(function(a,
b){console.log("Interval %d: (%d,%d)",b,a.from,a.to)})})},printTreeTopDown:function(){g(a).forEach(function(a,c){console.log("Level %d:",c);a.forEach(function(a,c){console.log("Segment %d: (%d,%d)",c,a.segment.from,a.segment.to);a.intervals.forEach(function(a,b){console.log("  Pk.Interval %d: (%d,%d)",b,a.from,a.to)})})})},queryPoint:function(a,c){if("number"!==typeof a)throw{name:"InvalidParameter",message:"parameter must be a number"};return this.queryPointArray([a],c)},queryPointArray:function(a,
c,b){(void 0!==b?b:1)&&v(a);a=a.map(function(a){return new Pk.Interval(a,a)});return t(a,c)},queryInterval:function(a,c,b){r(a,c);return this.queryIntervalArray([a],[c],b)},queryIntervalArray:function(a,c,b){var g=[],e=void 0!==b&&void 0!==b.resultFn?b.resultFn:void 0,h=void 0!==b&&!1===b.endpoints?Pk.Interval.prototype.disjointExcl:Pk.Interval.prototype.disjointIncl;(void 0!==b&&void 0!==b.validate?b.validate:1)&&u(a,c);for(b=0;b<a.length;b++)g.push(new Pk.Interval(a[b],c[b]));return t(g,e,h)},queryOverlap:function(){q(a,
[]);var f=[];c.forEach(function(a){var b=new Pk.Interval;b.id=a.id;b.from=a.from;b.to=a.to;b.overlap=Object.keys(a.overlap);f.push(b)});return f}}};Pk={};Pk.Resource=function(){};Pk.Resource.prototype.Load=function(){console.error("NOT IMPLEMENTED")};Pk.Resource.prototype.Dispose=function(){console.error("NOT IMPLEMENTED")};Pk.TimecodeController=function(a){timePoll=a};Pk.TimecodeController.prototype={currentTimecode:0,Subscribe:function(a){this.subscribers.push(a)},SendTimecodeTick:function(a){Pk.Timeline.SetTimecode(a)},Update:function(){var a=timePoll();a!=this.currentTimecode&&(this.currentTimecode=a,this.SendTimecodeTick(a))}};Pk.Timeline=function(){var a=0,c=null,e=[],k=!1,l={},m=function(a){var c=[];Object.keys(l).forEach(function(e){if(Pk.Util.Exists(a[e]))delete a[e];else{var q=l[e];delete l[e];c.push(q.clip)}});p(c);n(Object.keys(a).map(function(c){return a[c].clip}));Object.keys(a).forEach(function(c){l[c]=a[c]})},n=function(a){a.forEach(function(a){a.group.ActivateClip(a)})},p=function(a){a.forEach(function(a){a.group.DeactivateClip(a)})};return{SetTimecode:function(e,h){Pk.Util.Exists(h)||(h=!0);if(h){var k={resultFn:m.bind(this)};
c.queryInterval(a,e,k)}Pk.Groups.forEach(function(a){a.Tick(e)});Pk.Groups.forEach(function(a){a.Draw()});a=e},Build:function(){c=new Pk.IntervalTree;e.forEach(function(a){c.pushInterval(a.interval)});c.buildTree();k=!0},Add:function(){if(!0===k)console.warn("Trying to add clips to a built timeline");else for(var a=arguments.length-1;0<=a;a--)if(arguments[a]instanceof Pk.Clip)e.push(arguments[a]);else throw"Trying to add a non-clip to the timeline";},SetPlayMode:function(a){Pk.Util.IsBool(a)}}}();Pk.Util={};Pk.Util.Work=function(a){for(var c=0;c<a;c++);};Pk.Util.Exists=function(a){return"undefined"!==typeof a};Pk.Util.IsBool=function(a){return!0===a||!1===a};Pk.Util.IsFunction=function(a){var c={};return Pk.Util.Exists(a)&&"[object Function]"===c.toString.call(a)};Pk.Video=function(a){time=-.01;videoElement=a;this.Initialize()};Pk.Video.FromUrl=function(a){var c=document.createElement("video"),e=document.createElement("source");e.src=a;c.appendChild(e);return new Pk.Video(c)};
Pk.Video.prototype={Time:function(){return Math.trunc(1E3*videoElement.currentTime)},Initialize:function(){videoImage=document.createElement("canvas");videoImage.width=videoElement.videoWidth;videoImage.height=videoElement.videoHeight;console.log("Video Size :"+videoImage.width+" "+videoImage.height);videoContext=videoImage.getContext("2d");videoContext.fillStyle="#000000";videoContext.fillRect(0,0,videoImage.width,videoImage.height);this.context=videoContext},StartPlaying:function(){videoElement.play();
videoElement.muted=!0;videoElement.loop=!0},GetMaterial:function(){this.texture||(videoTexture=new THREE.Texture(videoImage),videoTexture.minFilter=THREE.LinearFilter,videoTexture.magFilter=THREE.LinearFilter,this.texture=videoTexture);return movieMaterial=new THREE.MeshBasicMaterial({map:videoTexture,overdraw:!0,side:THREE.DoubleSide})},Tick:function(){videoElement.readyState===videoElement.HAVE_ENOUGH_DATA&&(this.context.drawImage(videoElement,0,0),this.texture&&(this.texture.needsUpdate=!0))},
Interrupted:function(){},GetTimecodeController:function(){return new Pk.TimecodeController(this.Time)}};